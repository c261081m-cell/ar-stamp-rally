<!DOCTYPE html> 
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ãƒãƒƒãƒ—ï¼ˆè§£èª¬ãƒ¢ãƒ¼ãƒ‰ï¼‰ | ARã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="css/style.css" />
  <style>
  :root{
    --accent:#005ABB;
    --bg:#fff;
    --text:#111;
    --muted:#666;
    --container: 980px;
    --radius: 14px;
    --menuShadow:0 10px 28px rgba(0,0,0,.15);
  }
  html,body{background:var(--bg);color:var(--text);margin:0}
  html,body,*,*::before,*::after{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.6}

  .wrap{max-width:var(--container);margin:0 auto;padding:clamp(10px,3vw,14px)}
  a.link{color:var(--accent);text-decoration:none;font-weight:800}

  /* ======= ä¸Šéƒ¨ï¼šã‚¹ãƒãƒ›å„ªå…ˆã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ======= */
  .top-grid{
    display:grid;
    grid-template-columns: 1fr auto;   /* ã‚¹ãƒãƒ›ï¼šãƒªãƒ³ã‚¯ / å³ã‚¢ã‚¤ã‚³ãƒ³ */
    grid-template-areas:
      "links  icon"
      "book   book";
    gap:8px;
    align-items:center;
    margin-bottom:clamp(10px,3vw,14px);
  }
  /* ensure top icon row sits above the map and has breathing room */
  .icon-row{ margin-bottom:12px; position:relative; z-index:1300 }
  .top-cell.left{grid-area:links; display:flex; justify-content:flex-start; gap:10px; flex-wrap:wrap}
  .top-cell.right{grid-area:icon; display:flex; justify-content:flex-end}
  .top-cell:nth-child(2){grid-area:book; display:block}

  /* å·¦ã®ãƒªãƒ³ã‚¯ï¼šå°ã•ã‚æ–‡å­—ã§1è¡Œåã¾ã‚‹ã‚ˆã†ã« */
  .top-cell.left .link{
    font-size: clamp(12px, 3.5vw, 13px);
    line-height:1.2;
    white-space:nowrap;
  }

  /* ======= ã‚¹ã‚¿ãƒ³ãƒ—å¸³ï¼ˆç‹¬ç«‹ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ï¼ã‚¹ãƒãƒ›æœ€é©ï¼‰ ======= */
  .stampbook{
    position:relative;
    width:100%;
    max-width:100%;
    background:#fff;border:1px solid #e9eef6;border-radius:14px;
    box-shadow:0 6px 24px rgba(0,0,0,.05);overflow:visible; /* ãƒ‘ãƒãƒ«ã‚’é‡ã­ã‚‹ãŸã‚ visible */
  }
  /* Top-row icons: unified rounded-square appearance for all five icons */
  .stamp-icon-btn{appearance:none;border:1px solid #e3eaf6;padding:6px;background:#fff;border-radius:12px;display:inline-flex;align-items:center;justify-content:center;width:48px;height:48px;cursor:pointer}
  .stamp-icon-btn img{width:28px;height:28px;object-fit:contain}
  /* Stamp icon: match other icons' size and tint only this button */
  #stampIconBtn{ width:48px; height:48px; padding:6px; border-radius:12px; background:#005ABB; border-color:#005ABB }
  #stampIconBtn img{ width:28px; height:28px; filter:brightness(0) invert(1); }
    /* Use flex to place icon above and label below (column-start). */
    .icon-with-label{ display:flex; flex-direction:column; align-items:center; justify-content:flex-start; height:72px; gap:6px; text-align:center }
    .icon-with-label .icon-label{ order:0; margin:0 }
    .icon-with-label .icon-btn, .icon-with-label .stamp-icon-btn{ position:static; transform:none }
  .icon-btn{display:inline-flex;align-items:center;justify-content:center;border-radius:12px;padding:6px;background:#fff;border:1px solid #e3eaf6;width:48px;height:48px;cursor:pointer}
  .icon-btn img{width:28px;height:28px;display:block}
  .icon-label{font-size:12px;color:var(--accent);width:48px;text-align:center;white-space:normal;word-break:break-word;line-height:1.15;font-weight:800;display:block}
  .icon-label.label-single{ width:auto; white-space:nowrap }
  /* stamp panel when expanded (floating) */
  .stamp-panel{position:fixed;left:8px;top:56px;z-index:1200;display:none;background:#fff;border:1px solid #e3eaf6;border-radius:12px;box-shadow:0 18px 48px rgba(0,0,0,.28);overflow:hidden;padding:8px}
  .stamp-panel.is-open{display:block}
  .stamp-panel-inner{display:grid;grid-template-columns:1fr;gap:12px;width:min(86vw,360px);max-width:360px;max-height:calc(100vh - 140px);overflow:auto;padding:12px}
  .stamp-panel .stamp-item{display:flex;flex-direction:column;align-items:center;gap:6px;padding:6px;border-radius:10px;width:100%}
  .stamp-panel .stamp-item .thumb{width:100%;aspect-ratio:1/1;border-radius:12px;overflow:hidden;background:#f3f6fc;border:1px solid #e3eaf6;display:flex;align-items:center;justify-content:center}
  .stamp-panel .thumb img{width:100%;height:100%;object-fit:cover; opacity:0; visibility:hidden; transition:opacity .18s, visibility .18s}
  .stamp-panel .stamp-item .title{font-size:13px;font-weight:800;text-align:center}
  /* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼šé«˜ã•ã‚’æŠ‘ãˆã€1è¡Œã§å®Œçµ */
  .stampbook-header{
    width:100%; text-align:center; background:#fff; color:#111;
    appearance:none;border:0; padding:8px 10px; font-weight:900; letter-spacing:.01em;
    display:flex; align-items:center; justify-content:center; gap:8px; cursor:pointer;
    font-size: clamp(13px, 3.8vw, 14px);
    line-height:1.1;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .stampbook-header .arrow{color:#333; font-size:12px}
  .stamp-count{font-size:11px;color:#333}

  /* ãƒ‘ãƒãƒ«æœ¬ä½“ï¼šãƒ˜ãƒƒãƒ€ãƒ¼ç›´ä¸‹ã«é‡ã­ã¦è¡¨ç¤ºï¼ˆç‹¬ç«‹å±•é–‹ï¼‰ */
  .stampbook-body{
    position:absolute;
    left:0; right:0; top:100%;
    display:none;
    background:#fff;
    border:1px solid #e3eaf6;
    border-top:0;
    border-radius:0 0 14px 14px;
    box-shadow:0 14px 32px rgba(0,0,0,.12);
    z-index:50;
    max-height:min(68vh, 520px);
    overflow:auto;
    padding:10px 12px 12px;
    overscroll-behavior:contain;
  }
  .stampbook.is-open .stampbook-body{ display:block; }
  .stampbook.is-open .stampbook-header{
    border-bottom:1px solid #e3eaf6;
    border-radius:14px 14px 0 0;
  }

  /* ======= ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰ï¼ˆã‚¹ãƒãƒ›2åˆ—/ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ3åˆ—ï¼‰ ======= */
  .stamp-grid{
    display:grid;
    grid-template-columns: repeat(2, minmax(0,1fr));
    gap:8px;
  }
  @media (min-width:560px){
    .stamp-grid{ grid-template-columns: repeat(3, minmax(0,1fr)); }
  }

  .stamp-cell{
    border:1px solid #e3eaf6; border-radius:12px; background:#fff;
    display:flex; flex-direction:column; align-items:center; text-align:center;
    gap:6px; padding:10px; min-height:auto;
  }
  .stamp-thumb{
    width:84px; height:84px; border-radius:12px; background:#eef5ff;
    overflow:hidden; display:flex; align-items:center; justify-content:center; flex:none;
  }
  .stamp-thumb img{width:100%; height:100%; object-fit:cover; opacity:0; visibility:hidden}
  /* ãƒ†ã‚­ã‚¹ãƒˆã‚’å°ã•ã‚ã«ï¼ˆã¯ã¿å‡ºã—é˜²æ­¢ï¼‰ */
  .stamp-meta{width:100%}
  .stamp-name{
    font-weight:800; line-height:1.2; margin-top:2px;
    font-size: clamp(11px, 3.2vw, 12px);
    word-break:keep-all;
  }
  .stamp-name h2{margin:0 0 2px; font-size:12px; line-height:1.1}
  .stamp-status{font-size: clamp(10px, 2.8vw, 11px); color:#333}
  .stamp-cell.is-got{background:#f3fbf5;border-color:#b7e4c7}
  .stamp-cell.is-got .stamp-status{color:#2b8a3e;font-weight:800}
  .mark{font-weight:700}
  .complete-inline{margin:8px 0 0;text-align:center;display:none}
  .complete-inline a{color:var(--accent);text-decoration:none;font-weight:900}

  /* ======= è¨€èªã‚¹ã‚¤ãƒƒãƒï¼ˆå³ä¸Šã‚¢ã‚¤ã‚³ãƒ³ï¼‰ ======= */
  .lang-switch{position:relative}
  .lang-btn{
    appearance:none;border:0;background:#fff;border:1px solid #e3eaf6;border-radius:12px;
    padding:6px; cursor:pointer;
    /* match tutorial icon size */
    width:48px; height:48px; display:inline-flex; align-items:center; justify-content:center;
  }
  .lang-btn:focus-visible{outline:3px solid rgba(0,90,187,.35)}
  .lang-icon{width:28px;height:28px;display:block}
  .lang-menu{
    position:absolute; right:0; margin-top:8px; background:#fff; border:1px solid #e3eaf6; border-radius:12px;
    box-shadow:var(--menuShadow); display:none; min-width:160px; overflow:hidden; z-index:20;
  }
  .lang-menu.is-open{display:block}
  .lang-item{
    display:block; width:100%; text-align:left; background:#fff; border:0; padding:10px 12px;
    cursor:pointer; font-weight:800; color:#000;
  }
  .lang-item:hover{background:#f2f6ff}

  .top-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px }
  .primary-grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:12px; align-items:start; margin-bottom:12px }


  /* ======= åœ°å›³ ======= */
  .map-wrap{
    position:relative;width:100%;max-width:920px;margin:0 auto 14px;background:#fff;
    border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,.05);overflow:hidden;
  }
  .map-img{display:block;width:100%;height:auto;object-fit:contain;background:#fff}
  .pin{position:absolute;width:56px;height:56px;transform:translate(-50%,-100%);display:inline-block}
  .pin img{width:100%;height:100%;display:block}
  .pin:focus-visible{outline:3px solid rgba(0,90,187,.35);border-radius:50%}

  /* ======= èª¬æ˜ãƒ†ã‚­ã‚¹ãƒˆ ======= */
  .hint{
    max-width:920px;margin:10px auto;color:#333;background:#f6f7fb;border:1px solid #e9eef6;
    border-radius:12px;padding:10px 12px;font-size:14px
  }


  /* ======= ç”»é¢æœ€ä¸‹éƒ¨ï¼šã‚«ãƒ¡ãƒ©èµ·å‹• ======= */
  .footer-cta{
    position:sticky;bottom:0;left:0;right:0;z-index:5;background:linear-gradient(to top,#fff,#fff 70%,rgba(255,255,255,0));
    padding:10px 0 max(12px, env(safe-area-inset-bottom));
  }
  .btn{
    appearance:none;border:0;border-radius:12px;padding:14px 16px;font-weight:900;
    background:var(--accent);color:#fff;cursor:pointer;width:100%;box-shadow:0 10px 30px rgba(0,90,187,.25)
  }
  .btn-secondary{background:#e9eef6;color:#111;box-shadow:none}

  /* ======= ã‚¹ãƒãƒƒãƒˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæ—¢å­˜ï¼‰ ======= */
  .camera-chooser-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);z-index:998;display:none}
  .camera-chooser-overlay.is-open{display:block}
  .camera-chooser{
    position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
    width:min(94vw,560px);max-height:78vh;overflow:auto;background:#fff;border-radius:16px;
    box-shadow:0 18px 48px rgba(0,0,0,.3);padding:14px;z-index:999;display:none
  }
  .camera-chooser.is-open{display:block}
  .camera-chooser h3{margin:0 0 8px;font-size:18px}
  .camera-chooser p{margin:0 0 10px;color:#333}

  /* show photos stacked vertically (one column) when choosing a spot */
  .camera-chooser .list{
    display:grid;
    grid-template-columns: 1fr;
    gap:12px;
    max-width:480px;
    margin:0 auto;
  }
  @media (min-width:520px){ .camera-chooser .list{ grid-template-columns: 1fr; } }
  .camera-chooser .item{ padding:0; border:none; background:transparent }

  .thumbWrap{
    position:relative; aspect-ratio:1/1; border-radius:12px; overflow:hidden;
    border:1px solid #e3eaf6; box-shadow:0 10px 26px rgba(0,0,0,.12); background:#f3f6fc;
  }
  .thumbWrap img{
    width:100%; height:100%; object-fit:cover; display:block;
    background:linear-gradient(90deg,#f2f5fb 25%,#e8eef9 37%,#f2f5fb 63%); background-size:400% 100%;
    animation: shimmer 1.4s ease infinite;
  }
  @keyframes shimmer{0%{background-position:100% 0}100%{background-position:0 0}}

  .thumbWrap .label{
    position:absolute; left:8px; right:8px; bottom:8px;
    font-weight:900; font-size:13px; line-height:1.2; color:#fff;
    text-shadow:
      -1px -1px 0 #2b3a68, 1px -1px 0 #2b3a68,
      -1px  1px 0 #2b3a68, 1px  1px 0 #2b3a68;
    background:linear-gradient(to top, rgba(0,0,0,.45), rgba(0,0,0,0));
    padding:8px 10px 10px; border-radius:0 0 10px 10px;
  }

  /* ======= å®Œèµ°ãƒ¢ãƒ¼ãƒ€ãƒ« ======= */
  .complete-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(2px);z-index:1000;display:none}
  .complete-overlay.is-open{display:block}
  .complete-modal{
    position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
    width:min(92vw,560px);max-height:80vh;overflow:auto;background:#fff;border-radius:18px;
    box-shadow:0 20px 60px rgba(0,0,0,.35);padding:20px;z-index:1001;display:none
  }
  .complete-modal.is-open{display:block}
  .complete-title{margin:0 0 6px;font-size:20px}
  .complete-lead{margin:0 0 14px}
  .complete-row{display:flex;gap:8px;flex-wrap:wrap}

  /* å–å¾—/æœªå–å¾—ã®è¦‹ãŸç›®ï¼ˆã‚¹ã‚¿ãƒ³ãƒ—å¸³ï¼‰ */
  .stamp-cell .stamp-thumb img { opacity:0; visibility:hidden }
  .stamp-cell.is-got .stamp-thumb img { opacity:1; visibility:visible; filter:none }
</style>
</head>
<body>
  <div id="pageRoot">
    <div class="wrap">
      <!-- Top bar: left = terms, right = language button (icon only) -->
      <div class="top-header">
        <div style="display:flex;align-items:center;gap:10px;">
          <a id="termsLink" class="link" href="terms.html?returnTo=map_noar.html" data-i18n="map.terms">Privacy & Terms</a>
          <a id="specialLinkTop" class="link" href="special.html" data-i18n="map.special" style="display:none;margin-left:8px;">ğŸŒŸ ã‚¹ãƒšã‚·ãƒ£ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</a>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <button id="langBtn" class="lang-btn" type="button" aria-haspopup="true" aria-expanded="false" aria-controls="langMenu">
            <img class="lang-icon" src="assets/images/ui/lang.png?v=20251120" alt="è¨€èª / Language">
          </button>
          <div id="langMenu" class="lang-menu" role="menu" aria-label="Language">
            <button class="lang-item" data-lang="ja" role="menuitem">æ—¥æœ¬èª</button>
            <button class="lang-item" data-lang="en" role="menuitem">English</button>
          </div>
        </div>
      </div>

      <!-- Primary icon grid: 4 columns (entry, tutorial, stampbook, survey) -->
      <div class="primary-grid">
        <div class="icon-with-label">
          <a id="entryIconBtn" class="icon-btn" href="entry.html"><img src="assets/images/ui/entry_icon.png?v=20251120" alt="ARã‚ã‚Š/ãªã—é¸æŠ"></a>
          <div class="icon-label" data-i18n="map.entry">ARã‚ã‚Š/ãªã—é¸æŠ</div>
        </div>
        <div class="icon-with-label">
          <a id="tutorialIconBtn" class="icon-btn" href="tutorial_noar.html"><img src="assets/images/ui/tutorial_icon.png?v=20251120" alt="ä½¿ã„æ–¹"></a>
          <div class="icon-label" data-i18n="map.tutorial">ä½¿ã„æ–¹</div>
        </div>
        <div class="icon-with-label">
          <button id="stampIconBtn" class="stamp-icon-btn" aria-haspopup="true" aria-expanded="false" aria-controls="stampPanel">
            <img src="assets/images/ui/stamp_icon.png?v=20251120" alt="ã‚¹ã‚¿ãƒ³ãƒ—å¸³">
          </button>
          <div class="icon-label label-single" data-i18n="map.stampbook">ã‚¹ã‚¿ãƒ³ãƒ—å¸³</div>
        </div>
        <div class="icon-with-label">
          <a id="surveyIconBtn" class="icon-btn" href="post-survey.html?returnTo=map_noar.html"><img src="assets/images/ui/survey_icon.png?v=20251120" alt="ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ"></a>
          <div class="icon-label label-single" data-i18n="map.checkComplete">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</div>
        </div>
      </div>

      <!-- Stamp panel (floating) -->
      <div id="stampPanel" class="stamp-panel" role="dialog" aria-hidden="true">
        <div class="stamp-panel-inner">
          <div class="stamp-item" data-spot="spot7">
            <div class="thumb"><img src="assets/images/stamps/stamp01.png" alt="stamp01"></div>
            <div class="meta"><div class="title">æœ¬é¤¨æ­£é¢ç„é–¢</div></div>
          </div>
          <div class="stamp-item" data-spot="spot8">
            <div class="thumb"><img src="assets/images/stamps/stamp02.png" alt="stamp02"></div>
            <div class="meta"><div class="title">å›³æ›¸é¤¨æ‰‹å‰</div></div>
          </div>
          <div class="stamp-item" data-spot="spot9">
            <div class="thumb"><img src="assets/images/stamps/stamp03.png" alt="stamp03"></div>
            <div class="meta"><div class="title">Dé¤¨è¨˜å¿µç¢‘</div></div>
          </div>
        </div>
      </div>

      <div class="map-wrap" aria-label="ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ãƒãƒƒãƒ—">
        <img class="map-img" src="assets/images/campasMap.png" alt="ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹åœ°å›³" />
        <!-- Map pins inserted here -->
        <!-- Positions are fractions of the map image size expressed as percentages. -->
        <a class="pin" id="pin1" href="#" role="link" aria-label="æœ¬é¤¨æ­£é¢ç„é–¢" data-lat="35.68625" data-lng="139.529805" style="left:calc(37.5% + 42px); top:calc(50% + 42px);"></a>
        <a class="pin" id="pin2" href="#" role="link" aria-label="å›³æ›¸é¤¨æ‰‹å‰" data-lat="35.687333" data-lng="139.529611" style="left:33.3333%; top:calc(25% + 28px);"></a>
        <a class="pin" id="pin3" href="#" role="link" aria-label="Dé¤¨è¨˜å¿µç¢‘" data-lat="35.687278" data-lng="139.530472" style="left:50%; top:calc(25% + 28px);"></a>
      </div>

      <!-- ç”»é¢æœ€ä¸‹éƒ¨ï¼šè§£èª¬ã‚’èª­ã‚€ -->
      <div class="footer-cta">
        <button id="cameraBtn" class="btn" data-i18n="map.openAR">è§£èª¬ã‚’èª­ã‚€</button>
      </div>
    </div>
  </div>

  <!-- ã‚¹ãƒãƒƒãƒˆé¸æŠã®å¹ãå‡ºã— -->
  <div id="cameraChooser" class="camera-chooser" role="dialog" aria-modal="true" aria-labelledby="cameraChooserTitle" aria-describedby="cameraChooserDesc">
    <h3 id="cameraChooserTitle">ã‚¹ãƒãƒƒãƒˆã‚’é¸ã‚“ã§ãã ã•ã„</h3>
    <p id="cameraChooserDesc" style="margin:0 0 10px;color:#333">å†™çœŸã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã‚¹ãƒãƒƒãƒˆè§£èª¬ã«ç§»å‹•ã—ã¾ã™ã€‚</p>
    <div id="cameraChooserList" class="list"></div>
    <div style="margin-top:10px;text-align:right">
      <button id="cameraChooserClose" class="btn btn-secondary" type="button">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- centralized complete modal â€” injected by js/complete.js -->

  <script src="js/firebase.js" defer></script>
  <script src="js/complete.js" defer></script>
  <script src="js/map_noar.js?v=20251101" defer></script>
  <!-- Map pin handlers: open native map app (iOS/Android) or fallback to Google Maps web -->
  <script>
    (function(){
      function isiOS(){ return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; }
      function isAndroid(){ return /Android/.test(navigator.userAgent); }

      function openNativeMap(lat, lng, label){
        label = label || '';
        // iOS: Apple Maps
        if (isiOS()){
          window.location.href = `https://maps.apple.com/?q=${encodeURIComponent(lat+','+lng)}&z=16`;
          return;
        }
        // Android: try geo: URI, which usually opens default maps app
        if (isAndroid()){
          const geo = `geo:${lat},${lng}?q=${lat},${lng}(${encodeURIComponent(label)})`;
          const now = Date.now();
          window.location.href = geo;
          setTimeout(()=>{
            if (Date.now() - now > 0) {
              window.location.href = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
            }
          }, 800);
          return;
        }
        // Fallback: use Google Maps web URL
        window.open(`https://www.google.com/maps/search/?api=1&query=${lat},${lng}`,'_blank');
      }

      document.addEventListener('DOMContentLoaded', ()=>{
        document.querySelectorAll('.map-wrap .pin').forEach(pin=>{
          pin.addEventListener('click', (e)=>{
            e.preventDefault();
            const lat = pin.dataset.lat;
            const lng = pin.dataset.lng;
            const label = pin.getAttribute('aria-label') || '';
            if (!lat || !lng) return;
            openNativeMap(lat, lng, label);
          });
        });
      });
    })();
  </script>
  <!-- ã‚¹ã‚¿ãƒ³ãƒ—å¸³é–‹é–‰ï¼ˆå˜ç‹¬æŒ™å‹•ï¼‰ -->
  <script>
    document.addEventListener('DOMContentLoaded', ()=>{
      // legacy toggle (if present)
      const legacyBtn = document.getElementById('stampToggle');
      const body = document.getElementById('stampBody');
      const arrow = legacyBtn?.querySelector('.arrow');
      const stampPanel = document.getElementById('stampPanel');

      function toggleStampPanel(v){
        // if floating panel exists, toggle it; otherwise fallback to legacy body
        if (stampPanel){
          const isOpen = stampPanel.classList.contains('is-open');
          const want = typeof v === 'boolean' ? v : !isOpen;
          stampPanel.classList.toggle('is-open', want);
          if (legacyBtn) legacyBtn.setAttribute('aria-expanded', want ? 'true' : 'false');
          return;
        }
        if (!body || !legacyBtn) return;
        const open = body.style.display === 'block';
        body.style.display = open ? 'none' : 'block';
        legacyBtn.setAttribute('aria-expanded', open ? 'false' : 'true');
        if (arrow) arrow.textContent = open ? 'â–¼' : 'â–²';
      }

      legacyBtn?.addEventListener('click', toggleStampPanel);
      // wire top-left stamp icon button to same toggle
      const stampIcon = document.getElementById('stampIconBtn');
      stampIcon?.addEventListener('click', (e)=>{ e.stopPropagation(); toggleStampPanel(); });
      // close on outside click
      document.addEventListener('click', ()=>{ const p = document.getElementById('stampPanel'); if (p) p.classList.remove('is-open'); });
    });
  </script>
  <!-- Show special-content top link when survey completed -->
  <script>
    (function(){
      function updateSpecialTop(){
        try{
          const el = document.getElementById('specialLinkTop');
          if (!el) return;
          const done = localStorage.getItem('survey_completed_v3') === 'true';
          el.style.display = done ? 'inline-block' : 'none';
        }catch(e){}
      }
      document.addEventListener('DOMContentLoaded', updateSpecialTop);
      window.addEventListener('storage', (ev)=>{ if (ev.key === 'survey_completed_v3') updateSpecialTop(); });
      window.addEventListener('app_lang_changed', updateSpecialTop);
    })();
  </script>
  <script>
    // wire stamp panel items: only bind clicks here. Stamp obtained state
    // is driven centrally by `renderStampUI` (Firebase + localStorage merged).
    document.addEventListener('DOMContentLoaded', ()=>{
      document.querySelectorAll('#stampPanel .stamp-item').forEach(item=>{
        const spot = item.dataset.spot;
        if (!spot) return;
        item.addEventListener('click', ()=>{
          try{ location.href = `explanation.html?spotId=${encodeURIComponent(spot)}&returnTo=map_noar.html`; }catch(e){}
          const p = document.getElementById('stampPanel'); if (p) p.classList.remove('is-open');
        });
      });
    });
  </script>

  <!-- è¨€èªãƒ¡ãƒ‹ãƒ¥ãƒ¼ & ç°¡æ˜“i18n -->
  <script>
    (function(){
      const DICT = {
        ja: {
          'map.terms': 'Privacy & Terms',
          'map.tutorial': 'ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«',
          'map.stampbook': 'ã‚¹ã‚¿ãƒ³ãƒ—å¸³',
          'map.notgot': 'æœªå–å¾—',
          'map.got': 'å–å¾—æ¸ˆã¿',
          'map.checkComplete': 'ğŸ“ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã«ç­”ãˆã‚‹',
          'map.checkCompleteRecommended': 'ğŸ“ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆï¼ˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆå¾Œæ¨å¥¨ï¼‰',
          'map.special': 'ğŸŒŸ ã‚¹ãƒšã‚·ãƒ£ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„',
          'map.entry': 'ARã‚ã‚Š/ãªã—é¸æŠ',
          'map.openAR': 'è§£èª¬ã‚’èª­ã‚€'
        },
        en: {
          'map.terms': 'Privacy & Terms',
          'map.tutorial': 'Tutorial',
          'map.stampbook': 'Stamp Book',
          'map.notgot': 'Not collected',
          'map.got': 'Collected',
          'map.checkComplete': 'ğŸ“ Take the survey',
          'map.checkCompleteRecommended': 'ğŸ“ Survey (recommended after complete)',
          'map.special': 'ğŸŒŸ Special Content',
          'map.entry': 'Go to AR / No-AR selection',
          'map.openAR': 'Read explanation'
        }
      };

      function getLang(){ try { return localStorage.getItem('app_lang') || 'ja'; } catch { return 'ja'; } }
      function setLang(lang){ try { localStorage.setItem('app_lang', lang); } catch{} }
      function applyI18n(lang){
        const dict = DICT[lang] || DICT.ja;
        document.querySelectorAll('[data-i18n]').forEach(el=>{
          const key = el.getAttribute('data-i18n');
          if (dict[key] != null) el.textContent = dict[key];
        });
        // ã‚¹ã‚¿ãƒ³ãƒ—çŠ¶æ…‹æ–‡å­—ã®æ›´æ–°
        document.querySelectorAll('.stamp-cell').forEach(cell=>{
          const got = cell.classList.contains('is-got');
          const mark = cell.querySelector('.stamp-status .mark');
          if (mark) mark.textContent = dict[got ? 'map.got' : 'map.notgot'];
        });
        document.documentElement.setAttribute('lang', lang === 'en' ? 'en' : 'ja');
      }

      // è¨€èªãƒ¡ãƒ‹ãƒ¥ãƒ¼æ“ä½œ
      (function initLangMenu(){
        const btn  = document.getElementById('langBtn');
        const menu = document.getElementById('langMenu');
        const items= menu?.querySelectorAll('.lang-item');
        const open = (v)=>{ if (!menu || !btn) return; menu.classList.toggle('is-open', v); btn.setAttribute('aria-expanded', v ? 'true':'false'); };
        btn?.addEventListener('click', (e)=>{ e.stopPropagation(); open(!menu.classList.contains('is-open')); });
        document.addEventListener('click', ()=> open(false));
        items?.forEach(it=>{ it.addEventListener('click', ()=>{ const lang = it.dataset.lang || 'ja'; setLang(lang); applyI18n(lang); try { window.dispatchEvent(new Event('app_lang_changed')); } catch(e){} }); });
      })();

      // ã‚«ãƒ¡ãƒ©é¸æŠï¼ˆã‚µãƒ ãƒã‚¤ãƒ«ä¸‹ã®ãƒ©ãƒ™ãƒ«ï¼‰ç”¨ã®è¾æ›¸ã¨é©ç”¨
      const NAMES = {
        ja: { spot7:'æœ¬é¤¨æ­£é¢ç„é–¢', spot8:'å›³æ›¸é¤¨æ‰‹å‰', spot9:'Dé¤¨è¨˜å¿µç¢‘', spot4:'ãƒãƒ£ãƒšãƒ«', spot5:'æ–°ä½“è‚²é¤¨', spot6:'æœ¬é¤¨ 3F' },
        en: { spot7:'Main Building â€” Front Entrance', spot8:'In Front of the Library', spot9:'D-Building Monument', spot4:'Chapel', spot5:'PEC-A', spot6:'University Hall 3F' }
      };

      function applyChooserLang(){
        const lang = getLang();
        const title = document.getElementById('cameraChooserTitle');
        const desc  = document.getElementById('cameraChooserDesc');
        const close = document.getElementById('cameraChooserClose');
        if (title) title.textContent = (lang === 'en') ? 'Choose a spot' : 'ã‚¹ãƒãƒƒãƒˆã‚’é¸ã‚“ã§ãã ã•ã„';
        if (desc)  desc.textContent  = (lang === 'en') ? 'Tap a photo to view the explanation.' : 'å†™çœŸã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã‚¹ãƒãƒƒãƒˆè§£èª¬ã«ç§»å‹•ã—ã¾ã™ã€‚';
        if (close) close.textContent = (lang === 'en') ? 'Close' : 'é–‰ã˜ã‚‹';
        document.querySelectorAll('#cameraChooserList .item').forEach(item=>{
          const spot = item.getAttribute('data-spot') || item.dataset.spot;
          const label = item.querySelector('.thumbWrap .label') || item.querySelector('.label');
          const text = (NAMES[lang] && NAMES[lang][spot]) ? NAMES[lang][spot] : null;
          if (label && text) label.textContent = text;
        });
      }

      const list = document.getElementById('cameraChooserList');
      if (list) { const mo = new MutationObserver(applyChooserLang); mo.observe(list, {childList:true, subtree:true}); }
      window.addEventListener('storage', (e)=>{ if (e.key === 'app_lang') applyChooserLang(); });
      window.addEventListener('app_lang_changed', applyChooserLang);
      document.addEventListener('DOMContentLoaded', ()=>{ applyI18n(getLang()); applyChooserLang(); });
    })();
  </script>
</body>
</html>