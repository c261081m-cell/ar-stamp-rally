<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>チュートリアル | ARスタンプラリー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root{
      --accent:#005ABB;
      --text:#111;
      --muted:#444;
      --bg:#fff;
      --card:#ffffff;
      --shadow:0 12px 32px rgba(0,0,0,.08);
      --radius:16px;
    }
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;line-height:1.6}
    .wrap{max-width:960px;margin:0 auto;padding:clamp(10px,3vw,16px);min-height:100vh;display:flex;flex-direction:column}
    header{padding:4px 0 8px}
    h1{font-size:20px;margin:0;font-weight:900}

    /* スライドカード */
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:clamp(12px,3vw,18px);
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:60vh;
    }

    /* 画像（正方形 1:1 で表示。トリミングしない） */
    .hero{
      width:100%;
      aspect-ratio: 1 / 1;
      border-radius:12px;
      overflow:hidden;
      background:#f3f6fc;
      border:1px solid #e9eef6;
      display:flex;align-items:center;justify-content:center;
    }
    .hero img{
      width:100%;
      height:100%;
      object-fit: contain;
      display:block;
    }

    /* テキストブロック（下1/4を想定） */
    .panel{
      margin-top:auto;
      background:#f7f9fe;
      border:1px solid #e3eaf6;
      border-radius:12px;
      padding:12px;
    }
    .panel p{margin:.4em 0}
    .pageDots{margin-top:6px;text-align:center;font-size:0}
    .dot{display:inline-block;width:9px;height:9px;margin:0 3px;border-radius:999px;background:#c9d6ee}
    .dot.active{background:var(--accent)}

    /* 利用規約スクロールボックス（1ページ目） */
    .termsBox{
      height:min(40vh, 320px);
      overflow:auto;
      background:#fff;
      border:1px solid #dfe7f7;
      border-radius:12px;
      padding:12px;
      line-height:1.55;
      font-size:14px;
      color:#222;
    }
    .agreeLine{
      display:flex;align-items:center;gap:10px;margin-top:10px
    }
    .agreeLine small{color:#333}

    /* CTA */
    .ctaRow{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;margin-top:10px}
    .btn{
      appearance:none;border:0;border-radius:12px;padding:14px 16px;
      font-weight:900;cursor:pointer;background:var(--accent);color:#fff;
      box-shadow:0 10px 28px rgba(0,90,187,.25);
      flex:1;min-width:160px;text-align:center
    }
    .btn[disabled]{opacity:.45;box-shadow:none;cursor:not-allowed}
    .btn-secondary{background:#e9eef6;color:#111;box-shadow:none}
    .btn-ghost{background:transparent;color:var(--accent);box-shadow:none}
    .footerSpace{height:max(8px, env(safe-area-inset-bottom))}

    /* 言語スイッチ（右上） */
    .lang-switch{position:fixed; right:12px; top:12px; z-index:2147483647}
    .lang-btn{
      appearance:none;border:0;background:#fff;border:1px solid #e3eaf6;border-radius:12px;
      padding:6px; cursor:pointer; box-shadow:0 10px 28px rgba(0,0,0,.15)
    }
    .lang-btn:focus-visible{outline:3px solid rgba(0,90,187,.35)}
    .lang-icon{width:28px;height:28px;display:block}
    .lang-menu{
      position:absolute; right:0; margin-top:8px; background:#fff; border:1px solid #e3eaf6; border-radius:12px;
      box-shadow:0 10px 28px rgba(0,0,0,.15); display:none; min-width:160px; overflow:hidden
    }
    .lang-menu.is-open{display:block}
    .lang-item{display:block; width:100%; text-align:left; background:#fff; border:0; padding:10px 12px; cursor:pointer; font-weight:800; color:#000}
    .lang-item:hover{background:#f2f6ff}

    /* モバイル配慮 */
    @media (max-width:560px){
      .btn{min-width:0}
    }
  </style>
</head>
<body>
  <!-- 言語スイッチ -->
  <div class="lang-switch" id="langSwitch">
    <button id="langBtn" class="lang-btn" type="button" aria-haspopup="true" aria-expanded="false" aria-controls="langMenu">
      <img class="lang-icon" src="assets/images/ui/lang.png" alt="言語 / Language">
    </button>
    <div id="langMenu" class="lang-menu" role="menu" aria-label="Language">
      <button class="lang-item" data-lang="ja" role="menuitem">日本語</button>
      <button class="lang-item" data-lang="en" role="menuitem">English</button>
    </div>
  </div>

  <div class="wrap">
    <header>
      <h1 data-i18n="tut.title">チュートリアル</h1>
    </header>

    <main class="card" id="slideRoot" aria-live="polite">
      <!-- 画像 -->
      <div class="hero" aria-hidden="true">
        <img id="slideImg" src="assets/images/tutorial_photos/tutorial_image01.png" alt="チュートリアル画像">
      </div>

      <!-- テキスト：下1/4相当 -->
      <section class="panel">
        <div id="slideText" style="min-height:4lh"></div>

        <!-- walkthrough first page removed -->

        <!-- ページドット -->
        <div class="pageDots" aria-hidden="true" id="dots"></div>

        <!-- ボタン群 -->
        <div class="ctaRow">
          <button id="prevBtn" class="btn btn-secondary" type="button" data-i18n="common.prev">戻る</button>
          <button id="nextBtn" class="btn" type="button" data-i18n="common.next">次へ</button>
        </div>
        <!-- 1ページ目は skip 非表示／2ページ目以降で表示 -->
        <div class="ctaRow" style="margin-top:2px">
          <button id="skipBtn" class="btn-ghost" type="button" style="display:none" data-i18n="common.skip">skip</button>
        </div>
      </section>
    </main>

    <div class="footerSpace"></div>
  </div>

  <script>
    // 版数クエリ（キャッシュ回避）
    if (!window.withV) {
      window.BUILD_V = window.BUILD_V || '20251005';
      window.withV = (url) => url + (url.includes('?') ? '&' : '?') + 'v=' + window.BUILD_V;
    }

    // 簡易 i18n 辞書（チュートリアル用）
    (function(){
      const DICT = {
        ja: {
          'tut.title': 'チュートリアル',
          'policy.title': 'プライバシーポリシー',
          'policy.p1': '本アプリケーションは大学の卒業研究の一環として実施されています。アンケート等でご記入いただいた情報は、本研究における分析目的のみに使用し、研究目的以外には一切利用いたしません。',
          'policy.p2': '収集したデータは、個人を特定できない形に匿名化したうえで統計的に処理・分析を行います。分析結果を公表する際にも、個人を識別出来る情報が含まれることはありません。',
          'policy.p3': 'また、利用者の同意なく第三者に個人情報を提供することはありません。',
          'policy.p4': '本アプリケーションは無料でご使用いただけますが、通信にかかる費用（モバイル通信料など）は利用者のご負担となります。',
          'terms.title': 'ご利用上の注意',
          'terms.p1': '本アプリは、AR（拡張現実）を用いた体験型コンテンツを含み、歩行や屋外での利用を伴う場合があります。ご利用の際は、周囲の安全に十分ご注意ください。また、AR利用中の事故・ケガ・機器の破損などについて、運営は一切の責任を負いかねます。',
          'agree': 'プライバシーポリシー・ご利用上の注意に同意します。',
          'common.prev': '戻る',
          'common.next': '次へ',
          'common.skip': 'skip',
          'slide1': 'ARスタンプラリーへようこそ！本アプリは北條により卒業研究のために開発されたものです。以下の注意事項を読み、同意してくださる方はチェックを入れてください。',
          'slide2': 'スタンプ台に貼ってあるタグを読んでください。',
          'slide3': '「カメラを起動」を押し、今いる場所を選択します。',
          'slide4': 'カメラと位置情報の許可をしてください。',
          'slide5': 'ARを見て、楽しみましょう！',
          'slide6': 'ここからスタンプが貰えます！',
          'slide7': 'クイズ&解説ページへ行き、クイズに挑戦しましょう。',
          'slide8': '3つ集めたらコンプリート！アンケートにお答えいただくとスペシャルコンテンツを見ることが出来ます。最後に「はじめる」を押してください。'
        },
        en: {
          'tut.title': 'Tutorial',
          'policy.title': 'Privacy Policy',
          'policy.p1': 'This application is conducted as part of a university graduation research project. Any information you provide (e.g., in the survey) will be used solely for analysis within this research and will not be used for any other purposes.',
          'policy.p2': 'Collected data will be anonymized so individuals cannot be identified, and will be processed and analyzed statistically. Even when publishing results, no personally identifiable information will be included.',
          'policy.p3': 'We will not provide personal information to third parties without the user’s consent.',
          'policy.p4': 'This application is free to use; however, any communication costs (e.g., mobile data charges) are borne by the user.',
          'terms.title': 'Cautions for Use',
          'terms.p1': 'This app includes AR (augmented reality) experiences and may involve walking and outdoor use. Please pay close attention to your surroundings for safety. The organizers cannot be held responsible for any accidents, injuries, or device damage that may occur during AR use.',
          'agree': 'I agree to the Privacy Policy and Cautions for Use.',
          'common.prev': 'Back',
          'common.next': 'Next',
          'common.skip': 'Skip',
          'slide1': 'Welcome to the AR Stamp Rally! This app was developed by Hojo as part of a graduation thesis. Please read the notes below and check the box if you agree.',
          'slide2': 'Scan the tag attached to the stamp stand.',
          'slide3': 'Tap “Open Camera” and choose your current location.',
          'slide4': 'Please allow camera and location permissions.',
          'slide5': 'Enjoy the AR experience!',
          'slide6': 'You can get a stamp here!',
          'slide7': 'Go to the Quiz & Explanation page and try the quiz.',
          'slide8': 'Collect all 3 to complete! If you answer the survey, you can view the special content. Finally, tap “Start”.'
        }
      };

      function getLang(){ try { return localStorage.getItem('app_lang') || 'ja'; } catch { return 'ja'; } }
      function setLang(v){ try { localStorage.setItem('app_lang', v); } catch{} }
      function i18n(key){ const lang=getLang(); return (DICT[lang]&&DICT[lang][key]) ?? (DICT.ja[key]||''); }

      window.applyLang = function(lang){
        setLang(lang);
        const dict = DICT[lang] || DICT.ja;
        document.querySelectorAll('[data-i18n]').forEach(el=>{
          const k = el.getAttribute('data-i18n');
          if (dict[k] != null) el.textContent = dict[k];
        });
        document.documentElement.setAttribute('lang', lang==='en'?'en':'ja');
        document.title = (lang==='en') ? 'Tutorial | AR Stamp Rally' : 'チュートリアル | ARスタンプラリー';
        // スライド本文の再描画
        render();
      };

      // 言語メニュー
      (function initLangMenu(){
        const btn  = document.getElementById('langBtn');
        const menu = document.getElementById('langMenu');
        const items= menu?.querySelectorAll('.lang-item');
        const open = (v)=>{ menu.classList.toggle('is-open', v); btn.setAttribute('aria-expanded', v?'true':'false'); };
        btn?.addEventListener('click', (e)=>{ e.stopPropagation(); open(!menu.classList.contains('is-open')); });
        document.addEventListener('click', ()=> open(false));
        items?.forEach(it=>{
          it.addEventListener('click', ()=> window.applyLang(it.dataset.lang || 'ja'));
        });
      })();

      // スライド定義（画像・テキスト）
      // 最初のウォークスルー（利用規約同意）を削除しました
      const slides = [
        { img: 'assets/images/tutorial_photos/tutorial_image03.png', htmlKey: 'slide2' },
        { img: 'assets/images/tutorial_photos/tutorial_image04.png', htmlKey: 'slide3' },
        { img: 'assets/images/tutorial_photos/tutorial_image02.png', htmlKey: 'slide4' },
        { img: 'assets/images/tutorial_photos/tutorial_image05.png', htmlKey: 'slide5' },
        { img: 'assets/images/tutorial_photos/tutorial_image06.png', htmlKey: 'slide6' },
        { img: 'assets/images/tutorial_photos/tutorial_image07.png', htmlKey: 'slide7' },
        { img: 'assets/images/tutorial_photos/tutorial_image08.png', htmlKey: 'slide8' }
      ];

  const imgEl   = document.getElementById('slideImg');
  const textEl  = document.getElementById('slideText');
      const dotsEl  = document.getElementById('dots');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const skipBtn = document.getElementById('skipBtn');

      let idx = 0;

      function renderDots(){
        dotsEl.innerHTML = '';
        for (let i=0;i<slides.length;i++){
          const d = document.createElement('span');
          d.className = 'dot' + (i===idx ? ' active' : '');
          dotsEl.appendChild(d);
        }
      }

      function render(){
        const lang = getLang();
        const s = slides[idx];
        imgEl.src = s.img;
        textEl.textContent = i18n(s.htmlKey);

        // ボタン文言（言語適用）
        prevBtn.style.visibility = (idx === 0 ? 'hidden' : 'visible');
        nextBtn.textContent = (idx === slides.length - 1) ? (lang==='en'?'Start':'はじめる') : i18n('common.next');
        // Walkthrough first page removed — no agreement gating
        nextBtn.disabled = false;
        skipBtn.style.display = 'inline-block';

        renderDots();
      }

      async function requestPermissions(){
        try {
          if (navigator.mediaDevices?.getUserMedia) {
            navigator.mediaDevices.getUserMedia({video:true}).then(s=>{ s.getTracks().forEach(t=>t.stop()); }).catch(()=>{});
          }
        } catch(e){}
        try {
          if (navigator.geolocation?.getCurrentPosition) {
            navigator.geolocation.getCurrentPosition(()=>{}, ()=>{}, {enableHighAccuracy:true, timeout:2000});
          }
        } catch(e){}
      }

      function goNext(){
        // request camera/location on the permissions slide (shifted after removal)
        if (idx === 2){ requestPermissions(); }
        if (idx < slides.length - 1){
          idx++;
          render();
        } else {
          try { localStorage.setItem('tutorial_done','1'); } catch {}
          location.href = withV('map.html');
        }
      }
      function goPrev(){ if (idx > 0){ idx--; render(); } }
      function skipAll(){ try { localStorage.setItem('tutorial_done','1'); } catch {} location.href = withV('map.html'); }

  // agreement checkbox removed; no event listener needed
      prevBtn.addEventListener('click', goPrev);
      nextBtn.addEventListener('click', goNext);
      skipBtn.addEventListener('click', skipAll);

      document.addEventListener('DOMContentLoaded', async ()=>{
        try { await window.ensureAnon?.(); } catch(e){}
        window.applyLang(getLang()); // 初期適用＋render()
      });
    })();
  </script>
</body>
</html>
